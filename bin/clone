#!/usr/bin/env bash
# Description: Wrapper for git clone. Handles GitHub/HTTPS shortcuts and existing directory collisions.
# Usage: clone <repo>
#        clone -h | --help

source "$HOME/.config/zsh/utils.sh"

set -euo pipefail
REPO_LIST="$HOME/.local/share/repos.txt"

cleanup() {
    if [ $? -ne 0 ]; then
        echo
        print_message info "Script interrupted..."
    fi
}
trap cleanup INT TERM

show_help() {
    echo "Usage: $(basename "$0") <repository>"
    echo
    echo "Arguments:"
    echo "  repository    URL, 'user/repo', or just 'repo'"
    echo "                - 'user/repo' -> git@github.com:user/repo.git"
    echo "                - 'repo'      -> git@github.com:muizzyranking/repo.git"
}

if [[ "${1:-}" == "-h" ]] || [[ "${1:-}" == "--help" ]]; then
    show_help
    exit 0
fi

if [ $# -eq 0 ]; then
    show_help
    exit 1
fi

repo="$1"
repo_url=""
repo_name=""

# Determine the actual repository URL
if [[ $repo =~ ^(https://|git@github|git@gitlab) ]]; then
    repo_url="$repo"
elif [[ $repo == */* ]]; then
    repo_url="https://github.com/$repo.git"
else
    repo_url="git@github.com:muizzyranking/$repo.git"
fi

# Extract the repository name for collision checks
repo_name=$(basename "$repo_url" .git)

# Check for existing directory
if [[ -d $repo_name ]]; then
    print_message error "Directory '$repo_name' already exists."
    read -r -p "Overwrite it? (This will remove the existing directory) (y/n): " overwrite_choice
    if [[ ! $overwrite_choice =~ ^[Yy]$ ]]; then
        print_message info "Operation cancelled."
        exit 0
    fi

    ABS_PATH=$(realpath "$repo_name")
    if [[ -f "$REPO_LIST" ]]; then
        sed -i "\|^$ABS_PATH$|d" "$REPO_LIST"
    fi

    if command -v trash &>/dev/null; then
        trash "$repo_name"
        print_message success "Existing directory moved to trash."
    else
        rm -rf "$repo_name"
        print_message success "Existing directory removed."
    fi
fi

# Clone the repository
echo "Cloning $repo_url..."
if git clone "$repo_url"; then
    ABS_PATH=$(realpath "$repo_name")
    mkdir -p "$(dirname "$REPO_LIST")"
    if ! grep -Fxq "$ABS_PATH" "$REPO_LIST" 2>/dev/null; then
        echo "$ABS_PATH" >> "$REPO_LIST"
    fi
    print_message success "Repository '$repo_name' cloned successfully."
else
    print_message error "Failed to clone repository."
    exit 1
fi
