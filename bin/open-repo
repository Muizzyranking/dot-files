#!/usr/bin/env bash
# Description: Opens the current git repository's remote URL in the default browser.
# Usage: open-repo [directory] [-b|--branch]

set -euo pipefail

source "$HOME/.config/zsh/utils.sh"

is_git_repo() {
    if ! git -C "$1" rev-parse --is-inside-work-tree &>/dev/null; then
        print_message error "Not a git repository: $1"
        exit 1
    fi
}

get_remote_url() {
    local url
    if ! url=$(git -C "$1" remote get-url origin 2>/dev/null) || [ -z "$url" ]; then
        print_message error "No remote 'origin' found."
        exit 1
    fi
    echo "$url"
}

get_current_branch() {
    local branch
    branch=$(git -C "$1" symbolic-ref --short HEAD 2>/dev/null)
    if [ $? -ne 0 ]; then
        print_message warning "Could not determine current branch."
        return 1
    fi
    echo "$branch"
}

open_url() {
    local url="$1"
    echo "Opening: $url"

    if grep -q Microsoft /proc/version 2>/dev/null || [[ "$(uname -r)" == *"microsoft"* ]]; then
        # WSL
        if command -v powershell.exe >/dev/null; then
            powershell.exe -Command "Start-Process '$url'"
        elif command -v wsl-open >/dev/null; then
            wsl-open "$url"
        else
            print_message error "Cannot find way to open URL in WSL."
            exit 1
        fi
    elif [[ "$OSTYPE" == "darwin"* ]]; then
        open "$url"
    elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
        xdg-open "$url"
    else
        print_message error "Unsupported OS."
        exit 1
    fi
}

# Args parsing
show_branch=false
target_dir=""

while [[ $# -gt 0 ]]; do
    case "$1" in
    -b | --branch)
        show_branch=true
        shift
        ;;
    -h | --help)
        echo "Usage: $(basename "$0") [directory] [-b|--branch]"
        exit 0
        ;;
    *)
        if [ -z "$target_dir" ]; then
            target_dir="$1"
        else
            print_message error "Unexpected argument: $1"
            exit 1
        fi
        shift
        ;;
    esac
done

if [ -z "$target_dir" ]; then
    target_dir="$(pwd)"
else
    # Resolve relative path
    if [[ "$target_dir" != /* ]]; then
        target_dir="$(pwd)/$target_dir"
    fi
fi

if [ ! -d "$target_dir" ]; then
    print_message error "Directory not found: $target_dir"
    exit 1
fi

is_git_repo "$target_dir"
remote_url=$(get_remote_url "$target_dir")

# Convert SSH to HTTPS
if [[ $remote_url == git@* ]]; then
    remote_url=$(echo "$remote_url" | sed 's/git@\(.*\):\(.*\)\.git/https:\/\/\1\/\2/')
fi
remote_url=${remote_url%.git}

# Append branch if requested
if [ "$show_branch" = true ]; then
    branch=$(get_current_branch "$target_dir") || true
    if [ -n "$branch" ]; then
        if [[ $remote_url == *"github.com"* ]]; then
            remote_url="${remote_url}/tree/${branch}"
        elif [[ $remote_url == *"gitlab.com"* ]]; then
            remote_url="${remote_url}/-/tree/${branch}"
        elif [[ $remote_url == *"bitbucket.org"* ]]; then
            remote_url="${remote_url}/src/${branch}"
        fi
    fi
fi

open_url "$remote_url"

