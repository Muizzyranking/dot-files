#!/usr/bin/env bash
# Description: Interactive port manager to view and kill listening processes.
# Usage: ports
# Dependencies: ss, fzf, awk

set -euo pipefail

# Check dependencies
for cmd in ss fzf awk; do
    if ! command -v "$cmd" >/dev/null 2>&1; then
        echo "Error: '$cmd' is required but not installed."
        exit 1
    fi
done

while true; do
    # Get port info
    port_info=$(ss -tulpn 2>/dev/null |
        awk 'NR>1 && $5 ~ /:[0-9]+$/ {
            match($5, /:([0-9]+)$/, port)
            if (match($0, /users:\(\("([^"]+)",pid=([0-9]+)/, proc)) {
                process = proc[1]
                pid = proc[2]
            } else if (match($0, /pid=([0-9]+)/, proc)) {
                pid = proc[1]
                process = "unknown"
            } else {
                process = "no-access"
                pid = "-"
            }
            printf "% -6s | % -5s | % -21s | % -30s | % -8s | %s\n", 
                port[1], $1, $5, process, pid, $2
        }' | sort -n)

    if [[ -z "$port_info" ]]; then
        echo "No listening ports found (or permission denied)."
        echo "Try running with sudo."
        exit 0
    fi

    header="PORT   | PROTO | ADDRESS               | PROCESS                        | PID      | STATE
───────────────────────────────────────────────────────────────────────────────────────────────
CTRL-K: kill | CTRL-F: force kill | CTRL-I: info | CTRL-L: lsof | CTRL-Y: copy port | CTRL-R: refresh | ESC: exit"

    selection=$(echo "$port_info" |
        fzf --tmux 95%,85% \
            --header="$header" \
            --prompt="Select port > " \
            --preview='\n                port=$(echo {} | awk -F"|" "{print $1}" | xargs)
                pid=$(echo {} | awk -F"|" "{print $5}" | xargs)
                
                if [[ "$pid" != "-" && "$pid" != "" ]]; then
                    echo "=== PROCESS INFO ==="
                    ps -p $pid -o pid,ppid,user,%cpu,%mem,vsz,rss,stat,start,time,command 2>/dev/null || echo "Info unavailable"
                    echo ""
                    echo "=== CONNECTIONS ==="
                    ss -tulpn 2>/dev/null | grep ":$port " || echo "No connections"
                else
                    echo "No process info (try sudo)"
                fi
            ' \
            --preview-window=top:40%:wrap \
            --bind "ctrl-r:reload(ss -tulpn 2>/dev/null | awk 'NR>1 && $5 ~ /:[0-9]+\$/ {match($5, /:([0-9]+)\$/, port); if (match($0, /users:\(\(\"([^\"]+)\",pid=([0-9]+)/, proc)) {process=proc[1];pid=proc[2]} else if (match($0, /pid=([0-9]+)/, proc)) {pid=proc[1];process=\"unknown\"} else {process=\"no-access\";pid=\"-\"}; printf \"%-6s | %-5s | %-21s | %-30s | %-8s | %s\\n\", port[1], $1, $5, process, pid, $2}' | sort -n)" \
            --bind "ctrl-y:execute-silent(echo {} | awk -F'|' '{print $1}' | xargs | clipcopy)" \
            --bind "ctrl-l:execute(port=\$(echo {} | awk -F'|' '{print $1}' | xargs); echo 'lsof -i :'$port; lsof -i :$port 2>/dev/null || echo 'No info'; read -p 'Hit Enter...'")" \
            --bind "ctrl-i:execute(pid=\$(echo {} | awk -F'|' '{print $5}' | xargs); if [[ \"$pid\" != \"-\" ]]; then ps -p $pid -f; else echo 'No PID'; fi; read -p 'Hit Enter...'")" \
            --expect=ctrl-k,ctrl-f)

    key=$(echo "$selection" | head -1)
    selected_line=$(echo "$selection" | tail -1)

    if [[ -z "$selected_line" ]]; then exit 0; fi

    port=$(echo "$selected_line" | awk -F'|' '{print $1}' | xargs)
    pid=$(echo "$selected_line" | awk -F'|' '{print $5}' | xargs)

    if [[ "$pid" == "-" || -z "$pid" ]]; then
        echo "No PID available (try sudo)."
        read -p "Press Enter..."
        continue
    fi

    case "$key" in
    ctrl-k)
        echo "Killing PID $pid (SIGTERM)..."
        kill "$pid" && echo "Success" || echo "Failed"
        sleep 1
        ;;
    ctrl-f)
        echo "Force killing PID $pid (SIGKILL)..."
        kill -9 "$pid" && echo "Success" || echo "Failed"
        sleep 1
        ;;
    esac
done