#!/usr/bin/env bash
# Description: Copies files from local storage to a remote server via SCP.
# Usage: cp-remote [options] <path_to_file> <ip_address>
#
# Options:
#   -r              Recursive copy (for directories)
#   -u <user>       Remote username (default: ubuntu)
#   -i <identity>   SSH identity file (default: ~/.ssh/id_rsa)
#   -h, --help      Show help

set -euo pipefail

usage() {
    echo "Usage: $(basename "$0") [options] <path_to_file> <ip_address>"
    echo
    echo "Options:"
    echo "  -r              Recursive copy (required for directories)"
    echo "  -u <user>       Remote username (default: ubuntu)"
    echo "  -i <identity>   SSH identity file (default: ~/.ssh/id_rsa)"
    echo "  -h, --help      Show this help message"
}

# Defaults
RECURSIVE=""
USERNAME="ubuntu"
SSH_KEY="$HOME/.ssh/id_rsa"

# Parse args
while [[ $# -gt 0 ]]; do
    case "$1" in
        -r)
            RECURSIVE="-r"
            shift
            ;;
        -u)
            USERNAME="$2"
            shift 2
            ;;
        -i)
            SSH_KEY="$2"
            shift 2
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        *)
            # Stop parsing flags if we hit a non-flag
            break
            ;;
    esac
done

if [ "$#" -ne 2 ]; then
    usage
    exit 1
fi

PATH_TO_FILE="$1"
IP="$2"

if [ ! -e "$PATH_TO_FILE" ]; then
    echo "Error: File or directory '$PATH_TO_FILE' not found."
    exit 1
fi

if [ -d "$PATH_TO_FILE" ] && [ -z "$RECURSIVE" ]; then
    echo "Error: '$PATH_TO_FILE' is a directory. Use -r."
    exit 1
fi

echo "Copying $PATH_TO_FILE to $USERNAME@$IP:~/"
scp -o StrictHostKeyChecking=no -i "$SSH_KEY" $RECURSIVE "$PATH_TO_FILE" "$USERNAME@$IP":~/