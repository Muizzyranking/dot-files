#!/usr/bin/env bash
# Description: Adds or updates the 'origin' remote for a git repository.
#              Initializes git if not present.
# Usage: add-remote [repo_name]
#        add-remote -h | --help

source "$HOME/.config/zsh/utils.sh"

set -euo pipefail

show_help() {
    echo "Usage: $(basename "$0") [repo_name]"
    echo
    echo "Arguments:"
    echo "  repo_name   The name of the repository (default: current directory name)"
    echo
    echo "Options:"
    echo "  -h, --help  Show this help message"
}

cleanup() {
    # Only print if we are exiting abnormally
    if [ $? -ne 0 ]; then
        echo
        print_message info "Script interrupted..."
    fi
}
trap cleanup INT TERM

if [[ "${1:-}" == "-h" ]] || [[ "${1:-}" == "--help" ]]; then
    show_help
    exit 0
fi

# Validate git installation
if ! command -v git >/dev/null 2>&1; then
    print_message error "Git is not installed. Please install git first."
    exit 1
fi

set_remote() {
    local remote_name="origin"
    local remote_url="$1"
    local command="$2"

    # Check if input looks like a full URL
    if [[ $remote_url =~ ^(https://|git@github|git@gitlab) ]]; then
        git remote "$command" "$remote_name" "$remote_url"
    else
        # Default to SSH github
        git remote "$command" "$remote_name" "git@github.com:muizzyranking/$remote_url.git"
    fi
}

# Git Init Check
if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
    print_message info "Not a git repository."
    read -r -p "Would you like to initialize a git repository here? (y/n): " init_choice
    if [[ $init_choice =~ ^[Yy]$ ]]; then
        if git init >/dev/null 2>&1; then
            print_message success "Git repository initialized successfully."
        else
            print_message error "Failed to initialize git repository."
            exit 1
        fi
    else
        print_message info "Operation cancelled."
        exit 0
    fi
fi

# Get repository name
repo_name=""
if [ $# -eq 0 ]; then
    current_dir=$(basename "$(pwd)")
    print_message info "No repository name provided. Current directory: $current_dir"
    read -r -p "Use '$current_dir' as repository name? (y/n): " use_dirname_choice
    if [[ $use_dirname_choice =~ ^[Yy]$ ]]; then
        repo_name="$current_dir"
    else
        print_message info "Please provide a repository name."
        exit 0
    fi
else
    repo_name="$1"
fi

# Set Remote
if git remote | grep -q "^origin$"; then
    print_message error "Remote 'origin' already exists."
    print_message info "Current 'origin': $(git remote get-url origin)"

    read -r -p "Update existing 'origin'? (y/n): " update_choice
    if [[ $update_choice =~ ^[Yy]$ ]]; then
        if set_remote "$repo_name" "set-url"; then
            print_message success "Remote 'origin' updated."
        else
            print_message error "Failed to update remote."
            exit 1
        fi
    fi
else
    if set_remote "$repo_name" "add"; then
        print_message success "Remote 'origin' added."
    else
        print_message error "Failed to add remote."
        exit 1
    fi
fi

echo
print_message info "Current remotes:"
echo "--------------------------------------------------------"
git remote -v

