#!/usr/bin/env bash
# Description: Interactive git branch switcher and creator using fzf.
# Usage: git-branches

set -euo pipefail

# Check dependencies
if ! command -v fzf >/dev/null 2>&1; then
    echo "Error: fzf is required."
    exit 1
fi

if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
    echo "‚ùå Error: Not inside a git repository"
    exit 1
fi

# Get branches
git_branches=$(git branch --all --format='%(refname:short)')

header="üåø GIT BRANCHES
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
ENTER: Switch/Create | CTRL-C: Cancel"

output=$(echo "$git_branches" | fzf --tmux 70% \
    --print-query \
    --reverse \
    --border \
    --prompt=\"üåø Checkout or Create > \"
    --header=\"$header\"
    --preview=\"git log --oneline --graph --color=always {} | head -n 20\")

if [ -z "$output" ]; then exit 0; fi

query=$(echo "$output" | head -1)
selection=$(echo "$output" | tail -1)

# Handle case where selection equals query (happens when creating new branch)
if [ "$query" == "$selection" ] && ! echo "$git_branches" | grep -q \"^$selection$\"; then
    selection=""
fi

if [ -n "$selection" ]; then
    if git show-ref --verify --quiet "refs/heads/$selection"; then
        echo "üîÑ Switching to local branch '$selection'..."
        git checkout "$selection"

    elif [[ "$selection" == *"/"* ]]; then
        # Handle remote branch
        local_name=$(echo "$selection" | sed 's/^[^	]*\///')
        if git show-ref --verify --quiet "refs/heads/$local_name"; then
            echo "üîÑ Switching to existing local branch '$local_name'..."
            git checkout "$local_name"
        else
            echo "‚òÅÔ∏è  Tracking remote branch '$selection' as '$local_name'..."
            git checkout --track "$selection"
        fi

    else
        echo "üîÑ Switching to '$selection'..."
        git checkout "$selection"
    fi

elif [ -n "$query" ]; then
    echo "‚ú® Branch '$query' does not exist."
    read -p "Create new branch '$query'? [Y/n] " -n 1 -r
    echo ""
    if [[ $REPLY =~ ^[Yy]$ ]] || [[ -z $REPLY ]]; then
        git checkout -b "$query"
        echo "‚úÖ Created and switched to '$query'"
    else
        echo "‚ùå Cancelled."
    fi
fi