#!/usr/bin/env bash

source "$HOME/.config/zsh/utils.sh"
# Description: Interactive process viewer and manager using fzf.
# Usage: procs
# Dependencies: fzf, ps

set -euo pipefail

require_or_exit fzf ps lsof

get_processes() {
    local fmt="pid,ppid,user,%cpu,%mem,vsz,rss,stat,start,time,comm,args"
    ps -u "$(whoami)" -o "$fmt" --sort=-%cpu | awk '
        NR==1 { next }
        {
            cmd = substr($0, index($0,$11))
            printf "%-8s | %-6s | %-6s | %-10s | %-8s | %-5s | %-8s | %-10s | %s\n",
                $1, $4, $5, $6, $7, $8, $9, $10, cmd
        }'
}

while true; do
    process_info=$(get_processes)

    if [[ -z "$process_info" ]]; then
        echo "No processes found"
        exit 0
    fi

    header="PID      | CPU%   | MEM%   | VSZ        | RSS      | STAT  | START    | TIME       | COMMAND
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ’€ CTRL-K: kill | âš¡ CTRL-F: force kill | ğŸ“‚ CTRL-O: open files | ğŸ“‹ CTRL-Y: copy PID | ğŸ”„ CTRL-R: refresh"

    selection=$(echo "$process_info" |
        fzf --tmux 95%,85% \
            --header="$header" \
            --prompt="Select process > " \
            --preview='
                pid=$(echo {} | awk -F"|" "{print \$1}" | xargs)
                if [[ -n "$pid" ]]; then
                    echo "=== DETAILS ==="
                    ps -p $pid -o pid,ppid,user,%cpu,%mem,vsz,rss,stat,start,time,command 2>/dev/null
                    echo ""
                    echo "=== OPEN FILES (top 10) ==="
                    lsof -p $pid 2>/dev/null | head -n 11
                fi
            ' \
            --preview-window=up:60%:wrap \
            --bind "ctrl-r:reload(ps -u \$(whoami) -o pid,ppid,user,%cpu,%mem,vsz,rss,stat,start,time,comm,args --sort=-%cpu | awk 'NR==1 { next } { cmd = substr(\$0, index(\$0,\$11)); printf \"%-8s | %-6s | %-6s | %-10s | %-8s | %-5s | %-8s | %-10s | %s\\n\", \$1, \$4, \$5, \$6, \$7, \$8, \$9, \$10, cmd }')" \
            --bind "ctrl-y:execute-silent(echo {} | awk -F'|' '{print \$1}' | xargs | clipcopy)" \
            --bind "ctrl-o:execute(pid=\$(echo {} | awk -F'|' '{print \$1}' | xargs); lsof -p \$pid 2>/dev/null | less)" \
            --expect=ctrl-k,ctrl-f)

    key=$(echo "$selection" | head -1)
    selected_line=$(echo "$selection" | tail -1)

    if [[ -z "$selected_line" ]]; then exit 0; fi

    pid=$(echo "$selected_line" | awk -F'|' '{print $1}' | xargs)

    case "$key" in
    ctrl-k)
        echo "Killing PID $pid (SIGTERM)..."
        kill "$pid" 2>/dev/null && echo "âœ… Success" || echo "âŒ Failed"
        ;;
    ctrl-f)
        echo "Force killing PID $pid (SIGKILL)..."
        kill -9 "$pid" 2>/dev/null && echo "âœ… Success" || echo "âŒ Failed"
        ;;
    esac

    sleep 0.5
done

